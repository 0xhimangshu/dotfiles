#!/usr/bin/env bash

# Weather codes and their corresponding icons
declare -A WEATHER_CODES=(
    ["113"]="â˜€ï¸"
    ["116"]="â›…"
    ["119"]="â˜ï¸"
    ["122"]="â˜ï¸"
    ["143"]="â˜ï¸"
    ["176"]="ğŸŒ§ï¸"
    ["179"]="ğŸŒ§ï¸"
    ["182"]="ğŸŒ§ï¸"
    ["185"]="ğŸŒ§ï¸"
    ["200"]="â›ˆï¸"
    ["227"]="ğŸŒ¨ï¸"    
    ["230"]="ğŸŒ¨ï¸"
    ["248"]="â˜ï¸"
    ["260"]="â˜ï¸"
    ["263"]="ğŸŒ§ï¸"
    ["266"]="ğŸŒ§ï¸"
    ["281"]="ğŸŒ§ï¸"
    ["284"]="ğŸŒ§ï¸"
    ["293"]="ğŸŒ§ï¸"
    ["296"]="ğŸŒ§ï¸"
    ["299"]="ğŸŒ§ï¸"
    ["302"]="ğŸŒ§ï¸"
    ["305"]="ğŸŒ§ï¸"
    ["308"]="ğŸŒ§ï¸"
    ["311"]="ğŸŒ§ï¸"
    ["314"]="ğŸŒ§ï¸"
    ["317"]="ğŸŒ§ï¸"
    ["320"]="ğŸŒ¨ï¸"
    ["323"]="ğŸŒ¨ï¸"
    ["326"]="ğŸŒ¨ï¸"
    ["329"]="â„ï¸"
    ["332"]="â„ï¸"
    ["335"]="â„ï¸"
    ["338"]="â„ï¸"
    ["350"]="ğŸŒ§ï¸"
    ["353"]="ğŸŒ§ï¸"
    ["356"]="ğŸŒ§ï¸"
    ["359"]="ğŸŒ§ï¸"
    ["362"]="ğŸŒ§ï¸"
    ["365"]="ğŸŒ§ï¸"
    ["368"]="ğŸŒ§ï¸"
    ["371"]="â„ï¸"
    ["374"]="ğŸŒ¨ï¸"
    ["377"]="ğŸŒ¨ï¸"
    ["386"]="ğŸŒ¨ï¸"
    ["389"]="ğŸŒ¨ï¸"
    ["392"]="ğŸŒ§ï¸"
    ["395"]="â„ï¸"
)

# Fetch weather data
WEATHER_DATA=$(curl -s "wttr.in/Jorhat?format=j1")

# Extract current conditions
CURRENT_TEMP=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].temp_C')
FEELS_LIKE=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].FeelsLikeC')
WEATHER_CODE=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].weatherCode')
WEATHER_DESC=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].weatherDesc[0].value')
WIND_SPEED=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].windspeedKmph')
HUMIDITY=$(echo "$WEATHER_DATA" | jq -r '.current_condition[0].humidity')

# Get weather icon
ICON="${WEATHER_CODES["$WEATHER_CODE"]:-"â˜ï¸"}"

# Format temperature with + for positive single digits
if [[ "$FEELS_LIKE" =~ ^-?[0-9]+\.?[0-9]*$ ]]; then
    TEMP_INT=${FEELS_LIKE%.*}
    EXTRA_CHAR=""
    if [ "$TEMP_INT" -gt 0 ] && [ "$TEMP_INT" -lt 10 ]; then
        EXTRA_CHAR="+"
    fi
else
    TEMP_INT=0
    EXTRA_CHAR=""
fi

# Create JSON output
TEXT="$ICON ${EXTRA_CHAR}${FEELS_LIKE}Â°C"
TOOLTIP="<b>${WEATHER_DESC} ${CURRENT_TEMP}Â°C</b>\nFeels like: ${FEELS_LIKE}Â°C\nWind: ${WIND_SPEED}Km/h\nHumidity: ${HUMIDITY}%"

# Output JSON
echo "{\"text\": \"$TEXT\", \"tooltip\": \"$TOOLTIP\"}"
